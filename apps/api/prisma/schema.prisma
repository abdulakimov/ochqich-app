generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum DeviceStatus {
  ACTIVE
  REVOKED
}

enum ChallengeStatus {
  PENDING
  USED
  EXPIRED
}

enum SessionStatus {
  ACTIVE
  REVOKED
}

enum AuditAction {
  LOGIN_OK
  LOGIN_FAIL
  DEVICE_ADD
  DEVICE_REVOKE
  OTP_START
  OTP_VERIFY_OK
  OTP_VERIFY_FAIL
}

model User {
  id        String    @id @default(cuid())
  phone     String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  devices   Device[]
  sessions  Session[]
  auditLogs AuditLog[]
}

model OtpVerification {
  id         String   @id @default(cuid())
  phone      String
  otpHash    String
  expiresAt  DateTime
  verifiedAt DateTime?
  createdAt  DateTime @default(now())

  @@index([phone, expiresAt])
}

model Device {
  id           String          @id @default(cuid())
  userId       String
  fingerprint  String
  publicKey    String
  deviceName   String?
  status       DeviceStatus    @default(ACTIVE)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  challenges   AuthChallenge[]
  sessions     Session[]

  @@unique([userId, fingerprint])
  @@index([userId, status])
}

model AuthChallenge {
  id         String          @id @default(cuid())
  deviceId   String
  nonce      String
  expiresAt  DateTime
  status     ChallengeStatus @default(PENDING)
  createdAt  DateTime        @default(now())
  usedAt     DateTime?
  device     Device          @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([deviceId, status])
}

model Session {
  id               String        @id @default(cuid())
  userId           String
  deviceId         String
  refreshTokenHash String        @unique
  status           SessionStatus @default(ACTIVE)
  expiresAt        DateTime
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  revokedAt        DateTime?
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  device           Device        @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([deviceId, status])
}

model AuditLog {
  id         String      @id @default(cuid())
  userId     String?
  deviceId   String?
  action     AuditAction
  metadata   Json?
  createdAt  DateTime    @default(now())
  user       User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, action])
  @@index([deviceId, action])
}
